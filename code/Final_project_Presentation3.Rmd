---
title: "Final project presentation 3"
author: "sadia kana"
date: "2023-08-14"
output: pdf_document
---

## Final project presentation 3

```{r}
# Load the necessary libraries
library(tidyverse)
library(reshape2)
library(wesanderson)
library(harrypotter)
library(ggpubr)
library(tagger)

library(tidyr)
library(dplyr)
library(pheatmap)
library(knitr)
library(kableExtra)
library(gganimate)
library(gapminder)
library(gifski)
library(knitr)
library(kableExtra)

```


```{r}
# Load the gene expression data and metadata
GeneExpression_data<- read.csv(file = "/Users/Student1/Downloads/QBS103_finalProject_geneExpression.csv")
Metadata<- read.csv(file =  "/Users/Student1/Downloads/QBS103_finalProject_metadata.csv")


# Loak at both the csv files using head function

  head(GeneExpression_data)
  head(Metadata)
```

```{r}
# Rename rownames of GeneExpression_data and Metadata
rownames(GeneExpression_data) <- GeneExpression_data$X
rownames(Metadata)<- Metadata$participant_id

# Check the renaming
 rownames(GeneExpression_data)
 rownames(Metadata)
 
 # Remove the x column from gene expression data and participant_id from Metadata
 GeneExpression_data<- GeneExpression_data[, -1]
 Metadata<- Metadata[, -1]
 
```



```{r}
# Now, subset GeneExpression data for CD24 gene
CD24Expression<- GeneExpression_data["CD24", ]

# Convert row to column in the Geneexpression data and CD24Expression
geneT_data<- as.data.frame(t(GeneExpression_data))
CD24Expression<- as.data.frame(t(CD24Expression))

# Check the transformed version
  head(geneT_data)
  head(CD24Expression)
  
# Now, calculate the variance for all genes in geneT_data
variance<- apply(geneT_data, MARGIN = 2, FUN = var)

# Organize the geneT_data according to the variance (highest to lowest)
geneT_data<- geneT_data[, order(variance, decreasing = T)]

# Now, subset the geneT_Data for first 15 genes
Heatmap_geneset<- geneT_data[, 1:15]

```

```{r}
# Link CD24Expression and Heatmap_geneset with Metadata

CD24Expression<-cbind(CD24Expression, Metadata)
Heatmap_geneset<- cbind(Heatmap_geneset, Metadata)


# View theCD24Expression and Hetamap_geneset

  head(CD24Expression)
  head(Heatmap_geneset)
  
  
  # Now clean the data
  # Remove unknown values from CD24Expression and Heatmap_geneset
   
CD24Expression<- CD24Expression[apply(CD24Expression, 1, function(x) all(x != "unknown")), ]
CD24Expression<- droplevels(na.omit(CD24Expression))
  
Heatmap_geneset<- Heatmap_geneset[apply(Heatmap_geneset, 1, function(x) all(x != "unknown")), ]
Heatmap_geneset<- droplevels(na.omit(Heatmap_geneset))


```

# Generate plots incorporating the feedback
```{r}

# A data frame name - CD24Expression

# A continuous covariate is "age"

# Two categorical covariates are "sex",  and "mechanical_ventilation"


# Now generate a theme
  MyTheme <- theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(color = "black", linewidth = rel(1)), plot.background = element_rect(fill = "white"), panel.background = element_blank(), legend.key = element_rect(fill = "white"), legend.position = "right")
  

# Select and onvert the continous covariate into numeric form
  CD24Expression$age <- as.numeric(CD24Expression[["age"]])

# Calculating mean, standard deviation for continuous covariate

MeanAge <- round(mean(CD24Expression$age, digits = 1, na.rm = T))
MedianAge<- round(median(CD24Expression$age, digits = 1, na.rm = T))
  
# Creating histogram
Histogram<- ggplot( CD24Expression) +
  geom_histogram(aes(CD24),bins = 20, color = "azure2", fill = "aquamarine4")+
  labs(x = substitute(paste(italic(CD24)," ", "expression")), y  = "Participant number")+
  MyTheme +
  theme(text = element_text(size = 10))+
  geom_vline(aes(xintercept = median(CD24Expression$CD24)), color = "magenta1", size = .8) +
  theme(plot.title = element_text(hjust = .35))+
  ggtitle(label =substitute(paste("The Expression Level of"," ", italic(CD24)," ", "gene")), subtitle = "Vertical line indicates median value")+
  theme(plot.subtitle = element_text(color = "magenta1"))
  
plot(Histogram)

# Generate the scatterplot
Scatterplot <- ggplot( CD24Expression, aes(x = age, y = CD24))+
  geom_point(color = "aquamarine4", alpha = .6, size = 3)+
  MyTheme+
  labs(title = substitute(paste("The association of ", italic(CD24)," ", "expression and"," ", "age")) ,x = substitute(paste("Age"," ","in yrs", " ", "(", "mean", "=", "62",","," ", "median","=", "62",")")), y = substitute(paste(italic(CD24)," ", "expression")))+
  theme(text = element_text(size = 11)) + 
  theme(plot.title = element_text(hjust = .35))

plot(Scatterplot)

# Now, generate the boxplot

Boxplot <- ggplot( CD24Expression, aes(x = sex, y = CD24, fill = mechanical_ventilation))+
  geom_boxplot() +
  MyTheme+
  scale_fill_manual(values = c("deepskyblue","aquamarine4"),name = "Mechanical ventilation", labels = c("No(75)", "Yes(51)"))+
  labs(title = substitute(paste("The association of ", italic(CD24)," ", "expression with sex and mechanical ventilation")), y = substitute(paste(italic(CD24)," ", "Expression")))+
  scale_x_discrete(name = "Sex", labels =c( "Female(51)", "Male(74)"))+
  theme(text = element_text(size = 10))


#Boxplot<- Box + str_to_title()
plot(Boxplot)


```

# â€¢	Generate a table of summary statistics for all the covariates you looked at and 2 additional continuous and 1 additional categorical variable (5 pts)
# Stratifying by one of your categorical variables
#	Tables should report n (%) for categorical variables 
#	Tables should report mean (sd) or median [IQR] for continuous variables
#	Tables should be cleanly formatted in LaTeX with a caption and referenced in the text using the table number as discussed in class.

```{r}

# Select the continuous and categorical variables
# Continuous co-variate  =  Age, Ferritin, Procalcitonin, Lactate 
# Categorical co-variate  = Sex, Mechanical ventilation, Icu status
# Table rows  = Age,Sex, Ferritin, Mechanical ventilation, Procalcitonin, Icu status, Lactate 


function_continous<- function(x){
  con_covariates<- na.omit(as.numeric(CD24Expression[[x]]))
  median<- round(median(con_covariates))
  IQR<- round(IQR(con_covariates))
  print(paste( median, "(", IQR, ")"))
}


table <- data.frame('Variable' = c('**Age** median (IQR)','**Sex** n (%)',
                                    "Female","Male",'**Ferritin** median (IQR)','**Mechanical ventilation** n (%)',
                                    "Female","Male", '**Procalcitonin** median (IQR)','**ICU status** n (%)',
                                    "Female","Male", '**Lactate** median (IQR)' ),
                     "Value" = c(function_continous("age"),'','10 (25.0)','30 (75.0)',function_continous("ferritin.ng.ml."),'','10 (25.0)','30 (75.0)',function_continous("procalcitonin.ng.ml.."),'','10 (25.0)','30 (75.0)', function_continous("lactate.mmol.l.")))

# Print table using kable
kable(x = table, caption = 'Table for continuous and categorical variables',
      col.names = c("Variable", "n = 81"),
      align = c('l','r'),escape = T) %>%
   add_indent(positions = c(3,4, 7, 8, 11,12)) %>%
  kable_classic()




```

# Generate a heatmap of at least 10 genes with tracking bars for your two selected categorical covariates. Heatmaps should include clustered rows and columns.	Heatmaps should include clustered rows and columns (mention which clustering algorithm used in your figure caption) 



```{r}

# Now, log2 normalize all gene columns from Heatmap_geneset
i<- c(1:15)
Heatmap_geneset[ , i] <- apply(Heatmap_geneset[ , i], 2,           
                    function(x) log2(x))

# Remove any rows with inf values (code suggestion from stackoverflow.com. I have customized the code for my dataset)
Heatmap_geneset %>% 
  rowwise %>% 
  filter(!any(is.infinite(c_across(where(is.numeric)))))

# Removing NaN from Heatmap_geneset rows
Heatmap_geneset<- na.omit(Heatmap_geneset)

# Creating annotation data and annotation colors for heatmaps

annotationData1<- as.data.frame(Heatmap_geneset$sex)
rownames(annotationData1)<-rownames(Heatmap_geneset)
annotationColor1<- list(Status = c("female" = "pink",
                                  "male" = "blue"))

annotationData2<- as.data.frame(Heatmap_geneset$mechanical_ventilation)
rownames(annotationData2)<-rownames(Heatmap_geneset)
annotationColor2<- list(Status = c("no" = "pink",
                                  "yes" = "blue"))

# Generate heatmaps with clustering by euclidean algorithm and tracking bar for sex or mechanical ventilation

pheatmap(Heatmap_geneset[, 1:15],
         fontsize_row = 4,
         fontsize_col = 8,
         clustering_distance_rows = 'euclidean',
         clustering_distance_cols = 'euclidean',
    annotation_row = annotationData1,
    annotation_colors = annotationColor1)

pheatmap(Heatmap_geneset[, 1:15],
         fontsize_row = 4,
         fontsize_col = 8,
         clustering_distance_rows = 'euclidean',
         clustering_distance_cols = 'euclidean',
    annotation_row = annotationData2,
    annotation_colors = annotationColor2)

```



#Going through the documentation for ggplot2, generate a plot type that we did not previously discuss in class that describes your data in a new and unique way (5 pts)

```{r}

CD24Expression$ferritin.ng.ml.<- na.omit(as.numeric(CD24Expression$ferritin.ng.ml.))
table(CD24Expression$ferritin)

g<- ggplot(CD24Expression, aes( x = ferritin.ng.ml., y =CD24))+
  geom_hex(bins = 30)+
  theme_classic()+
  labs(title =substitute(paste( "The association of ", italic("CD24")," ", "expression with ferritin")), x = "Ferritin", y =substitute(paste(italic("CD24"), " ","expression")))+
  theme(text = element_text(size = 11)) + 
  theme(plot.title = element_text(hjust = .35))
plot(g)
```

  
  
  





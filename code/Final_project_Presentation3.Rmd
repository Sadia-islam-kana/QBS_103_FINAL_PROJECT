---
title: "Final project presentation 3"
author: "sadia kana"
date: "2023-08-14"
output: pdf_document
---

## Final project presentation 3

```{r}
# Load the necessary libraries
library(tidyverse)
library(reshape2)
library(wesanderson)
library(harrypotter)
library(ggpubr)
library(tagger)

library(tidyr)
library(dplyr)
library(pheatmap)
library(knitr)
library(kableExtra)
library(gganimate)
library(gapminder)
library(gifski)

```


```{r}
# Load the gene expression data and metadata
GeneExpression_data<- read.csv(file = "/Users/Student1/Downloads/QBS103_finalProject_geneExpression.csv")
Metadata<- read.csv(file =  "/Users/Student1/Downloads/QBS103_finalProject_metadata.csv", stringsAsFactors = F, na.strings = ("unknown"))

Metadata<- droplevels(na.omit(Metadata))

# Loak at both the csv files using head function

  head(GeneExpression_data)
  head(Metadata)
```

```{r}
# Rename the first column of GeneExpression_data
colnames(GeneExpression_data) [1]<- "Genes"

# Check the renaming

  head(GeneExpression_data)
```



```{r}
# Convert the gene expression data into long format
longData<- reshape2::melt(GeneExpression_data, id.vars = ("Genes"),
                          value.name = "gene_expression", variable.name = "participant_id")

# Check the long format conversion

  head(longData)

```

```{r}
# Link longData with Metadata

LinkedData<- merge(longData, Metadata, by = "participant_id")

# View the linked data

  head(LinkedData)
  tail(LinkedData)
  
```

# Generate plots incorporating the feedback
```{r}
# A data frame name - LinkedData
# A list of one or more genes
GeneList = c("CD24")

# A list for one or more continuous covariates
Con.cov_List = c("age")

# A list of two categorical covariates
cat.cov_List = c ("sex", "mechanical_ventilation")

# Generating the function

function_pres <- function(data, GeneList, Con.cov_List, cat.cov_List){
 
  # Selecting the gene from genelist
  
  gene <- GeneList[[1]]

    # Subset data for the gene
  Gene_data<- data[data$Gene == gene, ]

  # Now generate a theme
  MyTheme <- theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(color = "black", linewidth = rel(1)), plot.background = element_rect(fill = "white"), panel.background = element_blank(), legend.key = element_rect(fill = "white"), legend.position = "right")
  

# select the continuous covariate
  con.list <- Con.cov_List[[1]]
# Convert the continous covariate into numeric form
  con.cov <- as.numeric(Gene_data[[con.list]])

# Calculating mean, standard deviation for continuous covariate

MeanCon <- round(mean(con.cov, digits = 1, na.rm = T))
MedianCon<- round(median(con.cov, digits = 1, na.rm = T))
  
# Selecting categorical covariate 1 and 2
  cat.list1 <- cat.cov_List[[1]]
  cat.list2 <- cat.cov_List[[2]]
  cat.cov1<- Gene_data[[cat.list1]]
  cat.cov2<- Gene_data[[cat.list2]]

# Creating histogram
Histogram<- ggplot( Gene_data) +
  geom_histogram(aes(gene_expression),bins = 20, color = "gold2", fill = "gold")+
  labs(x = substitute(paste(italic(gene)," ", "expression")), y  = "Participant number")+
  MyTheme +
  theme(text = element_text(size = 10))+
  geom_vline(aes(xintercept = median(Gene_data$gene_expression))) +
  theme(plot.title = element_text(hjust = .35))+
  ggtitle(label =substitute(paste("The Expression Level of"," ", italic(gene)," ", "gene")), subtitle = "Vertical line indicates median value")
  
plot(Histogram)

# Generate the scatterplot
Scatterplot <- ggplot( Gene_data, aes(x = {{con.cov}}, y = gene_expression))+
  geom_point(color = "red", alpha = .5, size = 3)+
  MyTheme+
  labs(title = substitute(paste("The association of ", italic(gene)," ", "expression and"," ", con.list)) ,x = substitute(paste("Age"," ","in yrs", " ", "(", "mean", "=", MeanCon,","," ", "median","=", MedianCon,")")), y = substitute(paste(italic(gene)," ", "expression")))+
  theme(text = element_text(size = 11)) + 
  theme(plot.title = element_text(hjust = .35))

plot(Scatterplot)

# Now, generate the boxplot

Boxplot <- ggplot( Gene_data, aes(x = {{cat.cov1}}, y = gene_expression, fill = {{cat.cov2}}))+
  geom_boxplot() +
  MyTheme+
  scale_fill_manual(values = c("blue3","firebrick"),name = "Mechanical ventilation", labels = c("No(75)", "Yes(51)"))+
  labs(title = substitute(paste("The association of ", italic(gene)," ", "expression with ", cat.list1," ", "and"," ", "mechanical ventilation")), y = substitute(paste(italic(gene)," ", "Expression")))+
  scale_x_discrete(name = "Sex", labels =c( "Female(51)", "Male(74)"))+
  theme(text = element_text(size = 10))

#Boxplot<- Box + str_to_title()
plot(Boxplot)
}


function_pres(LinkedData,GeneList , Con.cov_List, cat.cov_List)

 
```

# â€¢	Generate a table of summary statistics for all the covariates you looked at and 2 additional continuous and 1 additional categorical variable (5 pts)
# Stratifying by one of your categorical variables
#	Tables should report n (%) for categorical variables 
#	Tables should report mean (sd) or median [IQR] for continuous variables
#	Tables should be cleanly formatted in LaTeX with a caption and referenced in the text using the table number as discussed in class.

```{r}
# Continous_covariates<- c("age", "ferritin", "procalcitonin","lactate" )
# categorical_covariates<- c("sex", "mechanical_ventilation","icu-status")
# Table columns  = age, sex, ferritin, mechanical_ventilation, procalcitonin, icu_status, lactate

CD24_gene<- LinkedData[LinkedData$Genes == "CD24", ]

function_continous<- function(x){
  con_covariates<- CD24_gene[[con_covariateList]]
  median<- round(median(con_covariates))
  IQR<- round(IQR(con_covariates))
  print(paste("Median (IQR): ", median, "(", IQR, ")"))
}

function_categorical<- function(x){
  cat_covariates<- CD24_gene[[cat_covariateList]]
  percentage <- percent(cat_covariates)
   print(paste(cat_covariates, " (" , percentage, " ", ")"))
}






```

# Generate a heatmap of at least 10 genes with tracking bars for your two selected categorical covariates. Heatmaps should include clustered rows and columns. (10 pts)

```{r}
genelist <- LinkedData$Genes[1:15]

variance<- apply(LinkedData, MARGIN = 1, FUN = var)

# Order rows of miRNA so that highest variance in expression is on top
Data <- LinkedData[order(variance,decreasing = T),]

# Log2-normalize data for plotting
log2.data <- log2(Data)

pheatmap(log2.data[1:20,],
         cluster_rows = F,
         cluster_cols = F)

```

#Going through the documentation for ggplot2, generate a plot type that we did not previously discuss in class that describes your data in a new and unique way (5 pts)

```{r}
Gene_data<- LinkedData[LinkedData$Genes == "CD24", ]
Gene_data$ferritin.ng.ml.<- na.omit(as.numeric(Gene_data$ferritin.ng.ml.))
table(Gene_data$ferritin)

g<- ggplot(Gene_data, aes( x = ferritin.ng.ml., y =gene_expression))+
  geom_hex(bins = 30)+
  theme_classic()+
  labs(title =substitute(paste( "The association of ", italic("BPI")," ", "expression with ferritin")), x = "Ferritin", y = "CD24 expression")+
  theme(text = element_text(size = 11)) + 
  theme(plot.title = element_text(hjust = .35))
plot(g)
```

  
  
  
---
title: "Final project presentation 3"
author: "sadia kana"
date: "2023-08-14"
output: pdf_document
---

## Final project presentation 3

```{r}
# Load the necessary libraries
library(tidyverse)
library(reshape2)
library(wesanderson)
library(harrypotter)
library(ggpubr)
library(tagger)

library(tidyr)
library(dplyr)
library(pheatmap)
library(knitr)
library(kableExtra)
library(gganimate)
library(gapminder)
library(gifski)
library(knitr)
library(kableExtra)

```


```{r}
# Load the gene expression data and metadata
GeneExpression_data<- read.csv(file = "/Users/Student1/Downloads/QBS103_finalProject_geneExpression.csv")
Metadata<- read.csv(file =  "/Users/Student1/Downloads/QBS103_finalProject_metadata.csv", stringsAsFactors = F, na.strings = ("unknown"))

Metadata<- droplevels(na.omit(Metadata))

# Loak at both the csv files using head function

  head(GeneExpression_data)
  head(Metadata)
```

```{r}
# Rename the first column of GeneExpression_data
colnames(GeneExpression_data) [1]<- "Genes"

# Check the renaming

  head(GeneExpression_data)
```



```{r}
# Convert the gene expression data into long format
longData<- reshape2::melt(GeneExpression_data, id.vars = ("Genes"),
                          value.name = "gene_expression", variable.name = "participant_id")

# Check the long format conversion

  head(longData)

```

```{r}
# Link longData with Metadata

LinkedData<- merge(longData, Metadata, by = "participant_id")

# View the linked data

  head(LinkedData)
  tail(LinkedData)
  
```

# Generate plots incorporating the feedback
```{r}
# A data frame name - LinkedData
# A list of one or more genes
GeneList = c("CD24")

# A list for one or more continuous covariates
Con.cov_List = c("age")

# A list of two categorical covariates
cat.cov_List = c ("sex", "mechanical_ventilation")

# Generating the function

function_pres <- function(data, GeneList, Con.cov_List, cat.cov_List){
 
  # Selecting the gene from genelist
  
  gene <- GeneList[[1]]

    # Subset data for the gene
  Gene_data<- data[data$Gene == gene, ]

  # Now generate a theme
  MyTheme <- theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(color = "black", linewidth = rel(1)), plot.background = element_rect(fill = "white"), panel.background = element_blank(), legend.key = element_rect(fill = "white"), legend.position = "right")
  

# select the continuous covariate
  con.list <- Con.cov_List[[1]]
# Convert the continous covariate into numeric form
  con.cov <- as.numeric(Gene_data[[con.list]])

# Calculating mean, standard deviation for continuous covariate

MeanCon <- round(mean(con.cov, digits = 1, na.rm = T))
MedianCon<- round(median(con.cov, digits = 1, na.rm = T))
  
# Selecting categorical covariate 1 and 2
  cat.list1 <- cat.cov_List[[1]]
  cat.list2 <- cat.cov_List[[2]]
  cat.cov1<- Gene_data[[cat.list1]]
  cat.cov2<- Gene_data[[cat.list2]]

# Creating histogram
Histogram<- ggplot( Gene_data) +
  geom_histogram(aes(gene_expression),bins = 20, color = "azure2", fill = "gray")+
  labs(x = substitute(paste(italic(gene)," ", "expression")), y  = "Participant number")+
  MyTheme +
  theme(text = element_text(size = 10))+
  geom_vline(aes(xintercept = median(Gene_data$gene_expression)), color = "aquamarine4", size = .8) +
  theme(plot.title = element_text(hjust = .35))+
  ggtitle(label =substitute(paste("The Expression Level of"," ", italic(gene)," ", "gene")), subtitle = "Vertical line indicates median value")
  
plot(Histogram)

# Generate the scatterplot
Scatterplot <- ggplot( Gene_data, aes(x = {{con.cov}}, y = gene_expression))+
  geom_point(color = "aquamarine4", alpha = .6, size = 3)+
  MyTheme+
  labs(title = substitute(paste("The association of ", italic(gene)," ", "expression and"," ", con.list)) ,x = substitute(paste("Age"," ","in yrs", " ", "(", "mean", "=", MeanCon,","," ", "median","=", MedianCon,")")), y = substitute(paste(italic(gene)," ", "expression")))+
  theme(text = element_text(size = 11)) + 
  theme(plot.title = element_text(hjust = .35))

plot(Scatterplot)

# Now, generate the boxplot

Boxplot <- ggplot( Gene_data, aes(x = {{cat.cov1}}, y = gene_expression, fill = {{cat.cov2}}))+
  geom_boxplot() +
  MyTheme+
  scale_fill_manual(values = c("deepskyblue","aquamarine4"),name = "Mechanical ventilation", labels = c("No(75)", "Yes(51)"))+
  labs(title = substitute(paste("The association of ", italic(gene)," ", "expression with ", cat.list1," ", "and"," ", "mechanical ventilation")), y = substitute(paste(italic(gene)," ", "Expression")))+
  scale_x_discrete(name = "Sex", labels =c( "Female(51)", "Male(74)"))+
  theme(text = element_text(size = 10))

#Boxplot<- Box + str_to_title()
plot(Boxplot)
}


function_pres(LinkedData,GeneList , Con.cov_List, cat.cov_List)

 
```

# â€¢	Generate a table of summary statistics for all the covariates you looked at and 2 additional continuous and 1 additional categorical variable (5 pts)
# Stratifying by one of your categorical variables
#	Tables should report n (%) for categorical variables 
#	Tables should report mean (sd) or median [IQR] for continuous variables
#	Tables should be cleanly formatted in LaTeX with a caption and referenced in the text using the table number as discussed in class.

```{r}
# First subset LinkedData for CD24 gene
CD24_gene<- LinkedData[LinkedData$Genes == "CD24", ]

# Select the continuous and categorical variables
# Continuous co-variate  =  Age, Ferritin, Procalcitonin, Lactate 
# Categorical co-variate  = Sex, Mechanical ventilation, Icu status
# Table rows  = Age,Sex, Ferritin, Mechanical ventilation, Procalcitonin, Icu status, Lactate 


function_continous<- function(x){
  con_covariates<- na.omit(as.numeric(CD24_gene[[x]]))
  median<- round(median(con_covariates))
  IQR<- round(IQR(con_covariates))
  print(paste( median, "(", IQR, ")"))
}

function_categorical<- function(x){
  cat_covariates<- CD24_gene[[x]]
  n <- table(cat_covariates)
  percentage <- ((table(cat_covariates)/length(cat_covariates))*100)
   print(paste(n, " (" , percentage, " ", ")"))
}


table <- data.frame('Variable' = c('**Age** median (IQR)','**Sex** n (%)',
                                    "Female","Male",'**Ferritin** median (IQR)','**Mechanical ventilation** n (%)',
                                    "Female","Male", '**Procalcitonin** median (IQR)','**ICU status** n (%)',
                                    "Female","Male", '**Lactate** median (IQR)' ),
                     "Value" = c(function_continous("age"),'','10 (25.0)','30 (75.0)',function_continous("ferritin.ng.ml."),'','10 (25.0)','30 (75.0)',function_continous("procalcitonin.ng.ml.."),'','10 (25.0)','30 (75.0)', function_continous("lactate.mmol.l.")))

# Print table using kable
kable(x = table, caption = 'Table for continuous and categorical variables',
      col.names = c("Variable", "n = 81"),
      align = c('l','r'),escape = T) %>%
   add_indent(positions = c(3,4, 7, 8, 11,12)) %>%
  kable_classic()




```

# Generate a heatmap of at least 10 genes with tracking bars for your two selected categorical covariates. Heatmaps should include clustered rows and columns.	Heatmaps should include clustered rows and columns (mention which clustering algorithm used in your figure caption) 

```{r}

rownames(geneDATA)<- GeneExpression_data$Genes

# First, convert the columns in geneexpression data into numeric
geneDATA<- as.data.frame(lapply(GeneExpression_data, as.numeric))

# Check the conversion
class(geneDATA$COVID_01_39y_male_NonICU)

# Remove Genes column from genedata
geneDATA<- geneDATA[, -1]

# Rename the rownames of genedata
rownames(geneDATA)<- GeneExpression_data$Genes

# Check the renaming
head(geneDATA)

# Remove NA's from the dataset

geneDATA<- na.omit(geneDATA)

geneDATA<- droplevels(geneDATA)

# Check the removal
head(geneDATA)

# Remove zeroes from genedata
geneDATA[apply(geneDATA,1, function(x) all(x!= 0)),]

# Calculate variance for all genes

variance<- apply(geneDATA, MARGIN = 1, FUN = var)

# Organize the data according to the variance (highest to lowest)

geneDATA<- geneDATA[order(variance, decreasing = T), ]
# Remove zeroes from genedata
geneDATA<- geneDATA[apply(geneDATA,1, function(x) all(x!= 0)),]

# log2 normalization
log2.gene<- log2(geneDATA)

# generate heatmap

pheatmap(log2.gene[1:15, 1:25],
         cluster_rows = F,
         cluster_cols = F)

# Generating heatmap with clusters with euclidean clustering

pheatmap(log2.gene[1:15, 1:25],
         clustering_distance_rows = 'euclidean',
         clustering_distance_cols = 'euclidean')

# Change the fontsize and include all the participants

pheatmap(log2.gene[1:15, ],
         fontsize_row = 8,
         fontsize_col = 4,
         clustering_distance_rows = 'euclidean',
         clustering_distance_cols = 'euclidean')

# Creating annotation data and annotation colors

annotationData1<- data.frame(Metadata$sex)
annotationColor1<- list(Status = c("male" = "blue",
                                  "female" = "pink"))

pheatmap(log2.gene[1:15, 1:25],
         clustering_distance_rows = 'euclidean',
         clustering_distance_cols = 'euclidean',
         annotation_col = annotationData1,
         annotation_colors = annotationColor1)



```

#Going through the documentation for ggplot2, generate a plot type that we did not previously discuss in class that describes your data in a new and unique way (5 pts)

```{r}
Gene_data<- LinkedData[LinkedData$Genes == "CD24", ]
Gene_data$ferritin.ng.ml.<- na.omit(as.numeric(Gene_data$ferritin.ng.ml.))
table(Gene_data$ferritin)

g<- ggplot(Gene_data, aes( x = ferritin.ng.ml., y =gene_expression))+
  geom_hex(bins = 30)+
  theme_classic()+
  labs(title =substitute(paste( "The association of ", italic("BPI")," ", "expression with ferritin")), x = "Ferritin", y = "CD24 expression")+
  theme(text = element_text(size = 11)) + 
  theme(plot.title = element_text(hjust = .35))
plot(g)
```

  
  
  